<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trello Clone - Board</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        .board-container {
            display: flex;
            gap: 15px;
            padding: 20px;
            overflow-x: auto;
            min-height: 70vh;
        }
        .list {
            background: #f1f2f4;
            border-radius: 8px;
            padding: 12px;
            min-width: 300px;
            max-width: 300px;
        }
        .list-header {
            font-weight: bold;
            margin-bottom: 12px;
            padding: 8px;
        }
        .card {
            background: white;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            cursor: pointer;
        }
        .card:hover {
            background: #f8f9fa;
        }
        .add-card-btn {
            color: #6c757d;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
        }
        .add-card-btn:hover {
            background: #e9ecef;
        }
        .attachment-item {
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div id="app">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container-fluid">
                <a class="navbar-brand" href="/">‚Üê Back to Boards</a>
                <h4 id="board-title" class="text-white mb-0">Loading...</h4>
                <div>
                    <button class="btn btn-light btn-sm" onclick="addList()">Add List</button>
                </div>
            </div>
        </nav>

        <div id="board-container" class="board-container">
            <!-- Lists will be loaded here -->
        </div>
    </div>

    <!-- Add List Modal -->
    <div class="modal fade" id="addListModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New List</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addListForm">
                        <div class="mb-3">
                            <label for="listTitle" class="form-label">List Title</label>
                            <input type="text" class="form-control" id="listTitle" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitAddList()">Add List</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Card Modal -->
    <div class="modal fade" id="cardModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cardModalTitle">Card Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="cardTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="cardTitle">
                    </div>
                    <div class="mb-3">
                        <label for="cardDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="cardDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Attachments</label>
                        <input type="file" class="form-control" id="cardAttachment" accept="image/*">
                        <div id="attachments-container" class="mt-2">
                            <!-- Attachments will be shown here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="deleteCardBtn" style="display: none;">Delete Card</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveCard()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const boardId = {{ boardId }};
        let boardData = null;
        let currentCard = null;
        let sortables = [];

        async function loadBoard() {
            try {
                const response = await fetch(`/api/boards/${boardId}`);
                boardData = await response.json();
                document.getElementById('board-title').textContent = boardData.title;
                renderBoard();
            } catch (error) {
                console.error('Failed to load board:', error);
            }
        }

        function renderBoard() {
            const container = document.getElementById('board-container');
            container.innerHTML = boardData.lists.map(list => `
                <div class="list" data-list-id="${list.id}">
                    <div class="list-header">${list.title}</div>
                    <div class="cards-container" data-list-id="${list.id}">
                        ${list.cards.map(card => `
                            <div class="card" data-card-id="${card.id}" onclick="openCard(${card.id})">
                                ${card.title}
                            </div>
                        `).join('')}
                    </div>
                    <div class="add-card-btn" onclick="addCard(${list.id})">+ Add a card</div>
                </div>
            `).join('');

            initDragDrop();
        }

        function initDragDrop() {
            // Destroy existing sortables
            sortables.forEach(sortable => sortable.destroy());
            sortables = [];

            // Make lists sortable
            const boardContainer = document.getElementById('board-container');
            sortables.push(new Sortable(boardContainer, {
                handle: '.list-header',
                animation: 150,
                onEnd: function(evt) {
                    const listId = evt.item.dataset.listId;
                    const newPosition = evt.newIndex + 1;
                    reorderList(listId, newPosition);
                }
            }));

            // Make cards sortable within and between lists
            document.querySelectorAll('.cards-container').forEach(container => {
                sortables.push(new Sortable(container, {
                    group: 'cards',
                    animation: 150,
                    onEnd: function(evt) {
                        const cardId = evt.item.dataset.cardId;
                        const newListId = evt.to.dataset.listId;
                        const newPosition = Array.from(evt.to.children).indexOf(evt.item) + 1;
                        moveCard(cardId, newListId, newPosition);
                    }
                }));
            });
        }

        async function addList() {
            const modal = new bootstrap.Modal(document.getElementById('addListModal'));
            modal.show();
        }

        async function submitAddList() {
            const title = document.getElementById('listTitle').value;
            if (!title.trim()) return;

            try {
                const response = await fetch(`/api/boards/${boardId}/lists`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title })
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('addListModal')).hide();
                    document.getElementById('addListForm').reset();
                    loadBoard();
                }
            } catch (error) {
                console.error('Failed to add list:', error);
            }
        }

        async function addCard(listId) {
            try {
                const response = await fetch(`/api/lists/${listId}/cards`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: 'New Card' })
                });

                if (response.ok) {
                    loadBoard();
                }
            } catch (error) {
                console.error('Failed to add card:', error);
            }
        }

        async function reorderList(listId, position) {
            try {
                await fetch(`/api/lists/${listId}/position`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ position })
                });
            } catch (error) {
                console.error('Failed to reorder list:', error);
            }
        }

        async function moveCard(cardId, listId, position) {
            try {
                await fetch(`/api/cards/${cardId}/position`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ list_id: listId, position })
                });
            } catch (error) {
                console.error('Failed to move card:', error);
            }
        }

        function openCard(cardId) {
            // Find card in board data
            for (const list of boardData.lists) {
                const card = list.cards.find(c => c.id == cardId);
                if (card) {
                    currentCard = card;
                    document.getElementById('cardTitle').value = card.title;
                    document.getElementById('cardDescription').value = card.description || '';
                    document.getElementById('deleteCardBtn').style.display = 'inline-block';
                    document.getElementById('cardAttachment').value = '';
                    const attachmentsContainer = document.getElementById('attachments-container');
                    attachmentsContainer.innerHTML = '<div class="text-muted small">Upload an image to test storage.</div>';

                    const modal = new bootstrap.Modal(document.getElementById('cardModal'));
                    modal.show();
                    return;
                }
            }
        }

        async function saveCard() {
            if (!currentCard) return;

            const title = document.getElementById('cardTitle').value;
            const description = document.getElementById('cardDescription').value;

            try {
                const response = await fetch(`/api/cards/${currentCard.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, description })
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('cardModal')).hide();
                    loadBoard();
                }
            } catch (error) {
                console.error('Failed to save card:', error);
            }
        }

        async function handleAttachmentUpload(event) {
            if (!currentCard) return;
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            const attachmentsContainer = document.getElementById('attachments-container');

            try {
                const response = await fetch(`/api/cards/${currentCard.id}/attachments`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    let errorMessage = 'Upload failed.';
                    try {
                        const payload = await response.json();
                        if (payload && payload.error) {
                            errorMessage = payload.error;
                        }
                    } catch (e) {
                        // ignore JSON parsing errors
                    }
                    attachmentsContainer.innerHTML = `<div class="text-danger small">${errorMessage}</div>`;
                    return;
                }

                const attachment = await response.json();
                if (!attachment.id) {
                    attachmentsContainer.innerHTML = '<div class="text-danger small">Upload succeeded but no attachment id returned.</div>';
                    return;
                }

                const urlResponse = await fetch(`/api/attachments/${attachment.id}/url`);
                if (!urlResponse.ok) {
                    attachmentsContainer.innerHTML = '<div class="text-danger small">Failed to fetch attachment URL.</div>';
                    return;
                }

                const urlPayload = await urlResponse.json();
                const link = document.createElement('a');
                link.href = urlPayload.url;
                link.textContent = attachment.originalName || 'Attachment';
                link.target = '_blank';
                link.rel = 'noopener';

                const item = document.createElement('div');
                item.className = 'attachment-item';
                item.appendChild(link);

                if (urlPayload.expiresAt) {
                    const expires = document.createElement('span');
                    expires.className = 'text-muted small';
                    expires.textContent = `(expires ${new Date(urlPayload.expiresAt).toLocaleString()})`;
                    item.appendChild(expires);
                }

                if (attachmentsContainer.querySelector('.text-muted')) {
                    attachmentsContainer.innerHTML = '';
                }
                attachmentsContainer.appendChild(item);
            } catch (error) {
                attachmentsContainer.innerHTML = '<div class="text-danger small">Upload error.</div>';
                console.error('Failed to upload attachment:', error);
            }
        }

        // Load board on page load
        loadBoard();

        // Poll for updates every 10 seconds
        setInterval(loadBoard, 10000);

        document.getElementById('cardAttachment').addEventListener('change', handleAttachmentUpload);
    </script>
</body>
</html>